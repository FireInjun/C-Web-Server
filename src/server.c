#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h>
#include <arpa/inet.h>
#include <sys/wait.h>
#include <signal.h>
#include <time.h>
#include <sys/file.h>
#include <fcntl.h>
#define PORT "3490"
#define BACKLOG 10/
void sigchld_handler(int s){(void)s; int saved_errno = errno;while (waitpid(-1, NULL, WNOHANG) > 0);errno = saved_errno;}void start_reaper(void){struct sigaction sa;sa.sa_handler = sigchld_handler; sigemptyset(&sa.sa_mask);sa.sa_flags = SA_RESTART; if (sigaction(SIGCHLD, &sa, NULL) == -1){perror("sigaction");exit(1);}}void *get_in_addr(struct sockaddr *sa){if (sa->sa_family == AF_INET){return &(((struct sockaddr_in *)sa)->sin_addr);}return &(((struct sockaddr_in6 *)sa)->sin6_addr);}int get_listener_socket(char *port){int sockfd;struct addrinfo hints, *servinfo, *p;int yes = 1;int rv;memset(&hints, 0, sizeof hints);hints.ai_family = AF_UNSPEC;hints.ai_socktype = SOCK_STREAM;hints.ai_flags = AI_PASSIVE; if ((rv = getaddrinfo(NULL, port, &hints, &servinfo)) != 0){fprintf(stderr, "getaddrinfo: %s\n", gai_strerror(rv));return -1;}for (p = servinfo; p != NULL; p = p->ai_next){if ((sockfd = socket(p->ai_family, p->ai_socktype,p->ai_protocol)) == -1){continue;}if (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &yes,sizeof(int)) == -1){perror("setsockopt");close(sockfd);freeaddrinfo(servinfo); return -2;}if (bind(sockfd, p->ai_addr, p->ai_addrlen) == -1){close(sockfd);continue;}break;}freeaddrinfo(servinfo);{fprintf(stderr, "webserver: failed to find local address\n");return -3;}if (listen(sockfd, BACKLOG) == -1){close(sockfd);return -4;}return sockfd;}int send_response(int fd, char *header, char *content_type, char *body){const int max_response_size = 65536;char response[max_response_size];int content_length = strlen(body);time_t t1 = time(NULL);struct tm *ltime = localtime(&t1);int response_length = sprintf(response,"%s\n""Content-Length: %d\n""Content-Type: %s\n""Date: %s""Connection: close\n""\n""%s",header,content_length,content_type,asctime(ltime),body);printf("%s\n""Content-Length: %d\n""Content-Type: %s\n""Date: %s""Connection: close\n""\n""%s",header,content_length,content_type,asctime(ltime),body);int rv = send(fd, response, response_length, 0);if (rv < 0){perror("send");}return rv;}void resp_404(int fd){send_response(fd, "HTTP/1.1 404 NOT FOUND", "text/html", "<h1>404 Page Not Found</h1>");}void get_root(int fd){printf("fd is: %d \n", fd);send_response(fd, "HTTP/1.1 200 OK", "text/html", "<h1>SUCCESS</h1>");}void get_d20(int fd){srand(time(0));char diceRoll[1024];int randomRoll = 1 + rand() % 20;sprintf(diceRoll,"%d\n",randomRoll);send_response(fd, "HTTP/1.1 200 OK", "text/html", diceRoll);}void get_date(int fd){time_t rawTime;time(&rawTime);send_response(fd, "HTTP/1.1 200 OK", "text/html", asctime(gmtime(&rawTime)) );}void post_save(int fd, char *body){}char *find_start_of_body(char *header){printf("The header is %c", header);}void handle_http_request(int fd){const int request_buffer_size = 65536;char request[request_buffer_size];char *p;char request_type[8];char request_path[1024];char request_protocol[128];int bytes_recvd = recv(fd, request, request_buffer_size - 1, 0);if (bytes_recvd < 0){perror("recv");return;}request[bytes_recvd] = '\0';sscanf(request, "%s %s %s \n", request_type, request_path, request_protocol);printf("%s %s %s \n ", request_type, request_path, request_protocol);if (strcmp("GET", request_type) == 0){printf("Request type is: %s \n", request_type);if (strcmp("/", request_path) == 0){printf("We hit the root \n");get_root(fd);}else if (strcmp("/favicon.ico", request_path) == 0){get_root(fd);}else if(strcmp("/d20", request_path) == 0){get_d20(fd);}else if(strcmp("/date", request_path) == 0){get_date(fd);}else{printf("Error 404 \n");resp_404(fd);}}else{printf("Error 404 \n");resp_404(fd);}}int main(void){int newfd;struct sockaddr_storage their_addr;char s[INET6_ADDRSTRLEN];start_reaper();int listenfd = get_listener_socket(PORT);if (listenfd < 0){fprintf(stderr, "webserver: fatal error getting listening socket\n");exit(1);}printf("webserver: waiting for connections...\n");while (1){socklen_t sin_size = sizeof their_addr;newfd = accept(listenfd, (struct sockaddr *)&their_addr, &sin_size);if (newfd == -1){perror("accept");continue;}inet_ntop(their_addr.ss_family,get_in_addr((struct sockaddr *)&their_addr),s, sizeof s);printf("server: got connection from %s\n", s);handle_http_request(newfd);close(newfd);}return 0;}